<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,viewport-fit=cover">
    <title>ç¾è¡“é‘‘è³å¯¾è©±ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ v2.2 | Dissonance & Insight</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2C3E50; --secondary: #E74C3C; --accent: #3498DB;
            --success: #27AE60; --warning: #F39C12; --light: #ECF0F1;
            --dark: #34495E; --white: #FFFFFF;
        }
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Meiryo', sans-serif;
            line-height: 1.8; color: var(--primary);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            width: 100%; max-width: 900px; margin: 0 auto; background: var(--white);
            border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%);
            color: var(--white); padding: 40px 30px; text-align: center; position: relative;
        }
        header h1 { font-size: 2em; margin-bottom: 10px; font-weight: 700; }
        header p { opacity: 0.9; font-size: 0.95em; }
        .version-badge {
            position: absolute; top: 15px; right: 15px;
            background: rgba(255,255,255,0.2); padding: 5px 15px;
            border-radius: 20px; font-size: 0.8em;
        }
        .top-nav {
            background:#f8fafc; border-bottom:1px solid #e2e8f0;
            padding:8px 16px; text-align:right;
        }
        .top-nav button {
            padding:6px 12px; font-size:0.85em;
        }

        .main-content { padding: 40px 30px; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary); font-size: 0.95em; }
        input[type="text"], textarea {
            width: 100%; padding: 12px 15px; border: 2px solid var(--light);
            border-radius: 8px; font-size: 1em; transition: all 0.3s ease; font-family: inherit;
        }
        input:focus, textarea:focus {
            outline: none; border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        textarea { resize: vertical; min-height: 100px; }
        button {
            padding: 15px 30px; border: none; border-radius: 8px; font-size: 1em;
            font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: inherit;
        }
        .btn-primary { background: var(--accent); color: var(--white); }
        .btn-primary:hover { background: #2980b9; transform: translateY(-2px); }
        .btn-secondary { background: var(--light); color: var(--dark); }
        .btn-secondary:hover { background: #d0d7de; }

        /* ã‚¿ã‚¤ãƒãƒ¼ */
        .timer-box {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white; padding: 20px; border-radius: 12px; margin: 20px 0; text-align: center;
        }
        .timer-display {
            font-size: 3em; font-weight: bold; font-family: 'Courier New', monospace; margin: 15px 0;
        }
        .timer-btn {
            padding: 10px 20px; border: 2px solid white; background: transparent;
            color: white; border-radius: 6px; cursor: pointer; font-weight: 600;
            transition: all 0.3s ease; margin: 0 5px;
        }
        .timer-btn:hover { background: white; color: #f5576c; }

        /* å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
        .photo-upload-area {
            border: 3px dashed var(--light); border-radius: 12px; padding: 40px;
            text-align: center; cursor: pointer; transition: all 0.3s ease; margin: 20px 0;
        }
        .photo-upload-area:hover {
            border-color: var(--accent); background: rgba(52, 152, 219, 0.05);
        }
        .photo-preview {
            width:100%; max-width:100%; height:300px;
            border-radius: 8px; margin-top: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            object-fit: cover;
        }

        /* å¾©å…ƒé€šçŸ¥ */
        .restore-notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: white; padding: 20px 30px; border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 2000; display: none;
        }
        .restore-notification.show { display: block; animation: slideDown 0.3s ease; }
        @keyframes slideDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to   { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; right: 30px; background: var(--success);
            color: var(--white); padding: 15px 25px; border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); opacity: 0; transform: translateY(50px);
            transition: all 0.3s ease; z-index: 1000;
        }
        .toast.show { opacity: 1; transform: translateY(0); }

        /* ä¸€è¦§ç”¨ã‚«ãƒ¼ãƒ‰ */
        .list-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
            gap: 10px;
        }
        .artwork-list { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
        .artwork-card {
            display: flex; align-items: center; gap: 15px;
            padding: 12px 15px; border-radius: 10px; border: 1px solid var(--light);
            cursor: pointer; transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
        }
        .artwork-card:hover {
            background: #f8fafc; transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .card-thumb {
            width: 60px; height: 60px; border-radius: 8px; object-fit: cover;
            background: #ddd; flex-shrink: 0;
        }
        .card-meta { display: flex; flex-direction: column; gap: 3px; }
        .card-title { font-weight: 600; font-size: 0.98em; }
        .card-artist { font-size: 0.9em; opacity: 0.8; }
        .card-date { font-size: 0.8em; opacity: 0.7; }
        .empty-state {
            text-align: center; padding: 30px 10px; opacity: 0.8;
            font-size: 0.95em;
        }

        /* è©³ç´°è¡¨ç¤º */
        .detail-photo {
            max-width: 100%; max-height: 400px; border-radius: 12px;
            display: block; margin: 0 auto 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            object-fit: cover;
        }
        .detail-block { margin-bottom: 20px; }
        .detail-label {
            font-size: 0.85em; font-weight: 600; opacity: 0.7; margin-bottom: 4px;
            text-transform: uppercase; letter-spacing: 0.06em;
        }
        .detail-text { font-size: 1em; line-height: 1.8; }
        .detail-title-artist { font-size: 1.1em; font-weight: 600; }

        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ãƒ©ãƒ™ãƒ« */
        .axis-hint {
            font-size: 0.85em; opacity: 0.75; margin-top: 2px;
        }

        /* ã‚¹ãƒãƒ›èª¿æ•´ */
        @media only screen and (max-width: 600px) {
            body { padding: 10px; }
            .container { border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
            header { padding: 24px 16px; }
            header h1 { font-size: 1.4em; }
            .main-content { padding: 24px 16px; }
            .list-header { flex-direction: column; align-items: stretch; }
            button { width: 100%; }
            .artwork-card { padding: 10px 12px; }
            .card-thumb { width: 50px; height: 50px; }
            .timer-display { font-size: 2.2em; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="version-badge">v2.2 TimeÃ—Space</div>
        <h1>ğŸ¨ ç¾è¡“é‘‘è³å¯¾è©±ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h1>
        <p>Dissonance & Insight - Personal Edition</p>
    </header>

    <div class="top-nav">
        <button class="btn-secondary" onclick="showSection('sectionList')">
            ãƒˆãƒƒãƒ—ï¼ˆä¸€è¦§ï¼‰ã«æˆ»ã‚‹
        </button>
    </div>

    <div class="main-content">
        <!-- ä½œå“ä¸€è¦§ -->
        <div class="section active" id="sectionList">
            <div class="list-header">
                <h2>ğŸ“š é‘‘è³è¨˜éŒ²ä¸€è¦§</h2>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn-secondary" onclick="exportAllAsMarkdown()">ğŸ’¾ å…¨ä»¶Markdown</button>
                    <button class="btn-primary" onclick="startNewArtwork()">ï¼‹ æ–°ã—ã„ä½œå“ã‚’é‘‘è³</button>
                </div>
            </div>
            <div id="artworkListContainer"></div>
        </div>

        <!-- ä½œå“åŸºæœ¬æƒ…å ± -->
        <div class="section" id="section1">
            <h2 style="margin-bottom: 25px;">ğŸ“‹ ä½œå“ã®åŸºæœ¬æƒ…å ±</h2>

            <div class="form-group">
                <label>ä½œå“ã®å†™çœŸ <span style="opacity: 0.7;">(æ¨å¥¨)</span></label>
                <div class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
                    <div id="uploadPrompt">
                        <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“·</div>
                        <p style="font-weight: 600;">ã‚¯ãƒªãƒƒã‚¯ã—ã¦å†™çœŸã‚’é¸æŠï¼ˆã‚«ãƒ¡ãƒ©èµ·å‹•å¯ï¼‰</p>
                    </div>
                    <img id="photoPreview" class="photo-preview" style="display: none;">
                </div>
                <input type="file"
                       id="photoInput"
                       accept="image/*"
                       capture="environment"
                       style="display: none;"
                       onchange="handlePhotoUpload(event)">
            </div>

            <div class="form-group">
                <label>ä½œå“å *</label>
                <input type="text" id="artworkTitle" placeholder="ä¾‹: ç¡è“®">
            </div>
            <div class="form-group">
                <label>ä½œå®¶å *</label>
                <input type="text" id="artistName" placeholder="ä¾‹: ã‚¯ãƒ­ãƒ¼ãƒ‰ãƒ»ãƒ¢ãƒ">
            </div>

            <div style="display:flex; gap:10px; margin-top:20px; flex-wrap:wrap;">
                <button class="btn-secondary" onclick="showSection('sectionList')">â† ä¸€è¦§ã«æˆ»ã‚‹</button>
                <button class="btn-primary" onclick="goToStep(2)" style="flex:1;">
                    æ¬¡ã¸ï¼šç¬¬ä¸€å°è±¡ã‚’è¨˜éŒ² â†’
                </button>
            </div>
        </div>

        <!-- ç¬¬ä¸€å°è±¡ + æ™‚é–“Ã—ç©ºé–“è»¸ -->
        <div class="section" id="section2">
            <h2 style="margin-bottom: 25px;">ğŸ‘ï¸ ã‚ãªãŸã®ç¬¬ä¸€å°è±¡</h2>

            <div class="timer-box">
                <div style="font-size: 1.2em; font-weight: 600;">â° ç¬¬ä¸€å°è±¡ã‚¿ã‚¤ãƒãƒ¼</div>
                <div class="timer-display" id="timerDisplay">3:00</div>
                <p style="font-size: 0.9em; opacity: 0.9;">ç†æ€§ãŒä»‹å…¥ã™ã‚‹å‰ã®ã€Œç”Ÿã®åå¿œã€ã‚’è¨˜éŒ²</p>
                <div style="margin-top: 15px;">
                    <button class="timer-btn" onclick="startTimer()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
                    <button class="timer-btn" onclick="resetTimer()">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>

            <div class="form-group">
                <label>ä¸€æ–‡ã§ã®ç¬¬ä¸€å°è±¡ *</label>
                <textarea id="firstImpression" rows="3"
                          placeholder="ä¾‹: è¼ªéƒ­ãŒãªãã¦ã¼ã‚“ã‚„ã‚Šã—ã¦ã„ã‚‹ã‘ã©ã€ãªãœã‹å¿ƒãŒè½ã¡ç€ãçµµ"></textarea>
            </div>

            <div class="form-group">
                <label>æ™‚é–“çš„è·é›¢ï¼ˆéå» â† ç¾åœ¨ â†’ æœªæ¥ï¼‰</label>
                <input type="range" id="axisTime" min="0" max="100" value="50"
                       oninput="updateAxisLabels()">
                <div id="axisTimeLabel" class="axis-hint">ç¾åœ¨</div>
                <div class="axis-hint">
                    ãƒ’ãƒ³ãƒˆä¾‹ï¼šåˆ¶ä½œå½“æ™‚ã®è¦³å®¢ï¼ä»Šã®è‡ªåˆ†ï¼100å¹´å¾Œã®èª°ã‹ã¨ã—ã¦è¦‹ãŸæ™‚ã®é•ã„ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã™ã‚‹
                </div>
            </div>

            <div class="form-group">
                <label>ç‰©ç†çš„è·é›¢ï¼ˆæ¥è¿‘ â† æ¨™æº– â†’ é æ™¯ï¼‰</label>
                <input type="range" id="axisSpace" min="0" max="100" value="50"
                       oninput="updateAxisLabels()">
                <div id="axisSpaceLabel" class="axis-hint">æ¨™æº–ï¼ˆ2mï¼‰</div>
                <div class="axis-hint">
                    ãƒ’ãƒ³ãƒˆä¾‹ï¼š30cmã¾ã§è¿‘ã¥ã„ãŸæ™‚ï¼2mé›¢ã‚ŒãŸæ™‚ï¼å±•ç¤ºå®¤ã®ç«¯ã‹ã‚‰è¦‹ãŸæ™‚ã®è¦‹ãˆæ–¹ã®é•ã„ã‚’æ€ã„å‡ºã™
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px; flex-wrap:wrap;">
                <button class="btn-secondary" onclick="goToStep(1)">â† å‰ã«æˆ»ã‚‹</button>
                <button class="btn-primary" onclick="completeSession()" style="flex:1;">
                    è¨˜éŒ²ã‚’ä¿å­˜ âœ“
                </button>
            </div>
        </div>

        <!-- ä¿å­˜å®Œäº† -->
        <div class="section" id="section3">
            <h2 style="margin-bottom: 25px;">âœ… ä¿å­˜å®Œäº†</h2>
            <div style="background: #d1ecf1; padding: 30px; border-radius: 12px; text-align: center;">
                <div style="font-size: 4em; margin-bottom: 15px;">ğŸ’¾</div>
                <h3 style="color: var(--primary); margin-bottom: 15px;">ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ</h3>
                <p style="opacity: 0.8; line-height: 1.8;">
                    ã‚ãªãŸã®é‘‘è³è¨˜éŒ²ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
                    ä¸€è¦§ç”»é¢ã‹ã‚‰ã€ã„ã¤ã§ã‚‚è¦‹è¿”ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
                </p>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap:wrap;">
                    <button class="btn-primary" onclick="showSection('sectionList')">
                        ä¸€è¦§ã«æˆ»ã‚‹ ğŸ“š
                    </button>
                    <button class="btn-secondary" onclick="startNewArtwork()">
                        ç¶šã‘ã¦æ–°ã—ã„ä½œå“ã‚’é‘‘è³ â†’
                    </button>
                </div>
            </div>
        </div>

        <!-- ä½œå“è©³ç´° -->
        <div class="section" id="sectionDetail">
            <h2 style="margin-bottom: 25px;">ğŸ–¼ï¸ é‘‘è³è¨˜éŒ²ã®è©³ç´°</h2>
            <div id="detailContent"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap:wrap;">
                <button class="btn-secondary" onclick="showSection('sectionList')">ä¸€è¦§ã«æˆ»ã‚‹</button>
                <button class="btn-secondary" onclick="exportDetailAsMarkdown()">Markdownã§æ›¸ãå‡ºã™</button>
                <button class="btn-primary" onclick="startNewArtwork()">æ–°ã—ã„ä½œå“ã‚’é‘‘è³</button>
            </div>
        </div>
    </div>
</div>

<!-- å¾©å…ƒé€šçŸ¥ -->
<div class="restore-notification" id="restoreNotification">
    <h3 style="margin-bottom: 15px;">ğŸ’¾ å‰å›ã®é€”ä¸­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™</h3>
    <p style="margin-bottom: 20px;">ç¶šãã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ</p>
    <div style="display: flex; gap: 10px;">
        <button class="btn-primary" onclick="restoreData()">å¾©å…ƒã™ã‚‹</button>
        <button class="btn-secondary" onclick="dismissRestore()">æ–°è¦ä½œæˆ</button>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
    // é€²è¡Œä¸­ãƒ‡ãƒ¼ã‚¿
    let artworkData = {
        id: null,
        title: '', artist: '', firstImpression: '',
        photoDataURL: '', timestamp: null,
        axisTime: 50,
        axisSpace: 50
    };

    let currentStep = 1;
    let timerInterval = null;
    let timerSeconds = 180;
    let currentDetailId = null;

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
    window.addEventListener('DOMContentLoaded', function() {
        checkForSavedData();
        renderArtworkList();
        updateAxisLabels();
    });

    // localStorage ãƒ˜ãƒ«ãƒ‘
    function getArtworkRecords() {
        const raw = localStorage.getItem('artworkRecords');
        if (!raw) return [];
        try {
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
            console.error('Failed to parse artworkRecords', e);
            return [];
        }
    }

    function saveArtworkRecords(records) {
        localStorage.setItem('artworkRecords', JSON.stringify(records));
    }

    // ä¸€è¦§æç”»
    function renderArtworkList() {
        const container = document.getElementById('artworkListContainer');
        const records = getArtworkRecords();

        if (!records.length) {
            container.innerHTML = `
                <div class="empty-state">
                    ã¾ã é‘‘è³è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                    ã€Œï¼‹ æ–°ã—ã„ä½œå“ã‚’é‘‘è³ã€ã‹ã‚‰ã€æœ€åˆã®1æšã‚’è¨˜éŒ²ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
                </div>
            `;
            return;
        }

        records.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

        const listEl = document.createElement('div');
        listEl.className = 'artwork-list';

        records.forEach(rec => {
            const card = document.createElement('div');
            card.className = 'artwork-card';
            card.onclick = () => openDetail(rec.id);

            let thumb;
            if (rec.photoDataURL) {
                thumb = document.createElement('img');
                thumb.src = rec.photoDataURL;
                thumb.className = 'card-thumb';
            } else {
                thumb = document.createElement('div');
                thumb.className = 'card-thumb';
            }

            const meta = document.createElement('div');
            meta.className = 'card-meta';

            const title = document.createElement('div');
            title.className = 'card-title';
            title.textContent = rec.title || 'ï¼ˆç„¡é¡Œï¼‰';

            const artist = document.createElement('div');
            artist.className = 'card-artist';
            artist.textContent = rec.artist || 'ä½œè€…ä¸æ˜';

            const date = document.createElement('div');
            date.className = 'card-date';
            date.textContent = formatRelativeTime(rec.timestamp);

            meta.appendChild(title);
            meta.appendChild(artist);
            meta.appendChild(date);

            card.appendChild(thumb);
            card.appendChild(meta);

            listEl.appendChild(card);
        });

        container.innerHTML = '';
        container.appendChild(listEl);
    }

    function formatRelativeTime(timestamp) {
        if (!timestamp) return '';
        const now = Date.now();
        const diffMs = now - timestamp;
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHr = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHr / 24);

        if (diffSec < 60) return 'ãŸã£ãŸä»Š';
        if (diffMin < 60) return diffMin + 'åˆ†å‰';
        if (diffHr < 24) return diffHr + 'æ™‚é–“å‰';
        if (diffDay === 1) return 'æ˜¨æ—¥';
        if (diffDay < 7) return diffDay + 'æ—¥å‰';

        const d = new Date(timestamp);
        const y = d.getFullYear();
        const m = d.getMonth() + 1;
        const day = d.getDate();
        return `${y}/${m}/${day}`;
    }

    // æ–°è¦é–‹å§‹
    function startNewArtwork() {
        artworkData = {
            id: null,
            title: '', artist: '', firstImpression: '',
            photoDataURL: '', timestamp: null,
            axisTime: 50,
            axisSpace: 50
        };
        localStorage.removeItem('artworkData_v2');

        document.getElementById('artworkTitle').value = '';
        document.getElementById('artistName').value = '';
        document.getElementById('firstImpression').value = '';
        document.getElementById('photoPreview').style.display = 'none';
        document.getElementById('uploadPrompt').style.display = 'block';
        document.getElementById('photoPreview').src = '';
        document.getElementById('axisTime').value = 50;
        document.getElementById('axisSpace').value = 50;
        updateAxisLabels();
        resetTimer();

        showSection('section1');
    }

    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // é€”ä¸­ä¿å­˜ç¢ºèª
    function checkForSavedData() {
        const saved = localStorage.getItem('artworkData_v2');
        if (saved) {
            const data = JSON.parse(saved);
            const hoursSince = (new Date().getTime() - data.timestamp) / (1000 * 60 * 60);
            if (hoursSince < 24) {
                document.getElementById('restoreNotification').classList.add('show');
            } else {
                localStorage.removeItem('artworkData_v2');
            }
        }
    }

    function restoreData() {
        const saved = localStorage.getItem('artworkData_v2');
        if (saved) {
            artworkData = JSON.parse(saved);
            document.getElementById('artworkTitle').value = artworkData.title || '';
            document.getElementById('artistName').value = artworkData.artist || '';
            document.getElementById('firstImpression').value = artworkData.firstImpression || '';
            if (artworkData.photoDataURL) {
                document.getElementById('photoPreview').src = artworkData.photoDataURL;
                document.getElementById('photoPreview').style.display = 'block';
                document.getElementById('uploadPrompt').style.display = 'none';
            }
            document.getElementById('axisTime').value = artworkData.axisTime ?? 50;
            document.getElementById('axisSpace').value = artworkData.axisSpace ?? 50;
            updateAxisLabels();
            showToast('âœ… å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
            showSection('section1');
        }
        dismissRestore();
    }

    function dismissRestore() {
        document.getElementById('restoreNotification').classList.remove('show');
    }

    function autoSave() {
        artworkData.timestamp = new Date().getTime();
        localStorage.setItem('artworkData_v2', JSON.stringify(artworkData));
    }

    // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    function handlePhotoUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                artworkData.photoDataURL = e.target.result;
                document.getElementById('photoPreview').src = e.target.result;
                document.getElementById('photoPreview').style.display = 'block';
                document.getElementById('uploadPrompt').style.display = 'none';
                autoSave();
                showToast('âœ… å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
            };
            reader.readAsDataURL(file);
        }
    }

    // ã‚¿ã‚¤ãƒãƒ¼
    function startTimer() {
        if (timerInterval) return;
        timerInterval = setInterval(() => {
            timerSeconds--;
            updateTimerDisplay();
            if (timerSeconds <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                showToast('â° 3åˆ†çµŒéã—ã¾ã—ãŸï¼', 'warning');
            }
        }, 1000);
    }

    function resetTimer() {
        clearInterval(timerInterval);
        timerInterval = null;
        timerSeconds = 180;
        updateTimerDisplay();
    }

    function updateTimerDisplay() {
        const min = Math.floor(timerSeconds / 60);
        const sec = timerSeconds % 60;
        document.getElementById('timerDisplay').textContent =
            `${min}:${sec.toString().padStart(2, '0')}`;
    }

    // æ™‚é–“Ã—ç©ºé–“è»¸ãƒ©ãƒ™ãƒ«
    function labelTimeDistance(v) {
        if (v <= 10) return 'éå»ï¼ˆåˆ¶ä½œå½“æ™‚ï¼‰å¯„ã‚Š';
        if (v >= 90) return 'æœªæ¥ï¼ˆ100å¹´å¾Œï¼‰å¯„ã‚Š';
        if (v < 40)  return 'ã‚„ã‚„éå»å¯„ã‚Š';
        if (v > 60)  return 'ã‚„ã‚„æœªæ¥å¯„ã‚Š';
        return 'ç¾åœ¨';
    }
    function labelPhysicalDistance(v) {
        if (v <= 10) return 'æ¥è¿‘ï¼ˆ30cmï¼‰ã«è¿‘ã„';
        if (v >= 90) return 'é æ™¯ï¼ˆ50mï¼‰ã«è¿‘ã„';
        if (v < 40)  return 'æ¨™æº–ã‚ˆã‚Šè¿‘ã„';
        if (v > 60)  return 'æ¨™æº–ã‚ˆã‚Šé ã„';
        return 'æ¨™æº–ï¼ˆ2mï¼‰';
    }

    function updateAxisLabels() {
        const t = parseInt(document.getElementById('axisTime').value, 10);
        const s = parseInt(document.getElementById('axisSpace').value, 10);
        document.getElementById('axisTimeLabel').textContent  = labelTimeDistance(t);
        document.getElementById('axisSpaceLabel').textContent = labelPhysicalDistance(s);
    }

    // ã‚¹ãƒ†ãƒƒãƒ—ç§»å‹•
    function goToStep(step) {
        if (step === 2) {
            const title = document.getElementById('artworkTitle').value.trim();
            const artist = document.getElementById('artistName').value.trim();
            if (!title || !artist) {
                showToast('âš ï¸ ä½œå“åã¨ä½œå®¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            artworkData.title = title;
            artworkData.artist = artist;
            autoSave();
        }

        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('section' + step).classList.add('active');
        currentStep = step;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº† â†’ å¤šä½œå“é…åˆ—ã¸ä¿å­˜
    function completeSession() {
        const impression = document.getElementById('firstImpression').value.trim();
        if (!impression) {
            showToast('âš ï¸ ç¬¬ä¸€å°è±¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
            return;
        }
        artworkData.firstImpression = impression;
        artworkData.timestamp = new Date().getTime();
        artworkData.axisTime = parseInt(document.getElementById('axisTime').value, 10);
        artworkData.axisSpace = parseInt(document.getElementById('axisSpace').value, 10);

        if (!artworkData.id) {
            artworkData.id = crypto.randomUUID ? crypto.randomUUID() : String(artworkData.timestamp);
        }

        const records = getArtworkRecords();
        records.push(artworkData);
        saveArtworkRecords(records);

        localStorage.removeItem('artworkData_v2');
        renderArtworkList();
        showSection('section3');
        showToast('âœ… é‘‘è³è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
    }

    // è©³ç´°è¡¨ç¤º
    function openDetail(id) {
        const records = getArtworkRecords();
        const rec = records.find(r => r.id === id);
        if (!rec) {
            showToast('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'warning');
            return;
        }
        currentDetailId = id;

        const container = document.getElementById('detailContent');
        container.innerHTML = '';

        if (rec.photoDataURL) {
            const img = document.createElement('img');
            img.src = rec.photoDataURL;
            img.className = 'detail-photo';
            container.appendChild(img);
        }

        const infoBlock = document.createElement('div');
        infoBlock.className = 'detail-block';
        infoBlock.innerHTML = `
            <div class="detail-title-artist">
                ${rec.title || 'ï¼ˆç„¡é¡Œï¼‰'}<br>
                <span style="font-size:0.9em; opacity:0.8;">${rec.artist || 'ä½œè€…ä¸æ˜'}</span>
            </div>
        `;
        container.appendChild(infoBlock);

        const dateBlock = document.createElement('div');
        dateBlock.className = 'detail-block';
        const dt = new Date(rec.timestamp || Date.now());
        const dtText = `${dt.getFullYear()}å¹´${dt.getMonth()+1}æœˆ${dt.getDate()}æ—¥ `
            + `${dt.getHours().toString().padStart(2,'0')}:${dt.getMinutes().toString().padStart(2,'0')}`;
        dateBlock.innerHTML = `
            <div class="detail-label">é‘‘è³æ—¥æ™‚</div>
            <div class="detail-text">${dtText}</div>
        `;
        container.appendChild(dateBlock);

        const impressionBlock = document.createElement('div');
        impressionBlock.className = 'detail-block';
        impressionBlock.innerHTML = `
            <div class="detail-label">ç¬¬ä¸€å°è±¡</div>
            <div class="detail-text">${(rec.firstImpression || '').replace(/\n/g,'<br>') || 'ï¼ˆæœªå…¥åŠ›ï¼‰'}</div>
        `;
        container.appendChild(impressionBlock);

        const axisBlock = document.createElement('div');
        axisBlock.className = 'detail-block';
        const tLabel = labelTimeDistance(rec.axisTime ?? 50);
        const sLabel = labelPhysicalDistance(rec.axisSpace ?? 50);
        axisBlock.innerHTML = `
            <div class="detail-label">æ™‚é–“ Ã— ç©ºé–“ã®æ„Ÿè¦š</div>
            <div class="detail-text">
                æ™‚é–“çš„è·é›¢ï¼š${tLabel}<br>
                ç‰©ç†çš„è·é›¢ï¼š${sLabel}
            </div>
        `;
        container.appendChild(axisBlock);

        showSection('sectionDetail');
    }

    // Markdownæ›¸ãå‡ºã—ç”¨
    function formatDateForMD(timestamp) {
        const d = new Date(timestamp || Date.now());
        const y = d.getFullYear();
        const m = (d.getMonth()+1).toString().padStart(2,'0');
        const day = d.getDate().toString().padStart(2,'0');
        const hh = d.getHours().toString().padStart(2,'0');
        const mm = d.getMinutes().toString().padStart(2,'0');
        return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    function markdownForArtwork(rec) {
        const title = rec.title || 'ï¼ˆç„¡é¡Œï¼‰';
        const artist = rec.artist || 'ä½œè€…ä¸æ˜';
        const dt = formatDateForMD(rec.timestamp);
        const tLabel = labelTimeDistance(rec.axisTime ?? 50);
        const sLabel = labelPhysicalDistance(rec.axisSpace ?? 50);
        const impression = rec.firstImpression || '';

        return [
            `# ${title} â€“ ${artist}`,
            '',
            `- é‘‘è³æ—¥æ™‚: ${dt}`,
            `- æ™‚é–“çš„è·é›¢: ${tLabel}`,
            `- ç‰©ç†çš„è·é›¢: ${sLabel}`,
            '',
            '## ç¬¬ä¸€å°è±¡',
            impression,
            '',
            '## æ™‚é–“ Ã— ç©ºé–“ã®æ„Ÿè¦š',
            `- æ™‚é–“çš„è·é›¢: ${tLabel}`,
            `- ç‰©ç†çš„è·é›¢: ${sLabel}`,
            ''
        ].join('\n');
    }

    function downloadTextFile(content, filename, mime = 'text/markdown') {
        const blob = new Blob([content], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function exportDetailAsMarkdown() {
        if (!currentDetailId) {
            showToast('âš ï¸ æ›¸ãå‡ºã™ä½œå“ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
            return;
        }
        const records = getArtworkRecords();
        const rec = records.find(r => r.id === currentDetailId);
        if (!rec) {
            showToast('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'warning');
            return;
        }
        const md = markdownForArtwork(rec);
        const safeTitle = (rec.title || 'untitled').replace(/[\\\/:*?"<>|]/g, '_');
        const dt = formatDateForMD(rec.timestamp).replace(/[: ]/g, '-');
        const filename = `${dt}-${safeTitle}.md`;
        downloadTextFile(md, filename);
        showToast('âœ… Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ');
    }

    function exportAllAsMarkdown() {
        const records = getArtworkRecords();
        if (!records.length) {
            showToast('âš ï¸ æ›¸ãå‡ºã™é‘‘è³è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
            return;
        }
        const parts = [];
        records.sort((a,b) => (a.timestamp||0)-(b.timestamp||0));
        records.forEach((rec, idx) => {
            parts.push(markdownForArtwork(rec));
            if (idx !== records.length - 1) parts.push('---');
        });
        const all = parts.join('\n');
        const now = formatDateForMD(Date.now()).replace(/[: ]/g,'-');
        const filename = `artwork-records-${now}.md`;
        downloadTextFile(all, filename);
        showToast('âœ… å…¨ä»¶ã‚’Markdownã§æ›¸ãå‡ºã—ã¾ã—ãŸ');
    }

    // Toast
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.background = type === 'warning' ? '#e74c3c' : '#27ae60';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
</script>
</body>
</html>
