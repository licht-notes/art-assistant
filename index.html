<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,viewport-fit=cover">
    <title>ç¾è¡“é‘‘è³å¯¾è©±ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ v2.4 | Dissonance & Insight</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2C3E50; --secondary: #E74C3C; --accent: #3498DB;
            --success: #27AE60; --warning: #F39C12; --light: #ECF0F1;
            --dark: #34495E; --white: #FFFFFF;
        }
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Meiryo', sans-serif;
            line-height: 1.8; color: var(--primary);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            width: 100%; max-width: 900px; margin: 0 auto; background: var(--white);
            border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%);
            color: var(--white); padding: 40px 30px; text-align: center; position: relative;
        }
        header h1 { font-size: 2em; margin-bottom: 10px; font-weight: 700; }
        header p { opacity: 0.9; font-size: 0.95em; }
        .version-badge {
            position: absolute; top: 15px; right: 15px;
            background: rgba(255,255,255,0.2); padding: 5px 15px;
            border-radius: 20px; font-size: 0.8em;
        }
        .top-nav {
            background:#f8fafc; border-bottom:1px solid #e2e8f0;
            padding:8px 16px; text-align:right;
        }
        .top-nav button {
            padding:6px 12px; font-size:0.85em;
        }

        .main-content { padding: 40px 30px; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary); font-size: 0.95em; }
        input[type="text"], textarea, select {
            width: 100%; padding: 12px 15px; border: 2px solid var(--light);
            border-radius: 8px; font-size: 1em; transition: all 0.3s ease; font-family: inherit;
        }
        input:focus, textarea:focus, select:focus {
            outline: none; border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        textarea { resize: vertical; min-height: 100px; }
        button {
            padding: 15px 30px; border: none; border-radius: 8px; font-size: 1em;
            font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-family: inherit;
        }
        .btn-primary { background: var(--accent); color: var(--white); }
        .btn-primary:hover { background: #2980b9; transform: translateY(-2px); }
        .btn-secondary { background: var(--light); color: var(--dark); }
        .btn-secondary:hover { background: #d0d7de; }

        /* å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
        .photo-upload-area {
            border: 3px dashed var(--light); border-radius: 12px; padding: 40px;
            text-align: center; cursor: pointer; transition: all 0.3s ease; margin: 20px 0;
        }
        .photo-upload-area:hover {
            border-color: var(--accent); background: rgba(52, 152, 219, 0.05);
        }
        .photo-preview {
            width:100%; max-width:100%; height:300px;
            border-radius: 8px; margin-top: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            object-fit: cover;
        }

        /* å¾©å…ƒé€šçŸ¥ */
        .restore-notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: white; padding: 20px 30px; border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 2000; display: none;
        }
        .restore-notification.show { display: block; animation: slideDown 0.3s ease; }
        @keyframes slideDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to   { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; right: 30px; background: var(--success);
            color: var(--white); padding: 15px 25px; border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); opacity: 0; transform: translateY(50px);
            transition: all 0.3s ease; z-index: 1000;
        }
        .toast.show { opacity: 1; transform: translateY(0); }

        /* ä¸€è¦§ç”¨ã‚«ãƒ¼ãƒ‰ */
        .list-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
            gap: 10px;
        }
        .artwork-list { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
        .artwork-card {
            display: flex; align-items: center; gap: 15px;
            padding: 12px 15px; border-radius: 10px; border: 1px solid var(--light);
            cursor: pointer; transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
        }
        .artwork-card:hover {
            background: #f8fafc; transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .card-thumb {
            width: 60px; height: 60px; border-radius: 8px; object-fit: cover;
            background: #ddd; flex-shrink: 0;
        }
        .card-meta { display: flex; flex-direction: column; gap: 3px; }
        .card-title { font-weight: 600; font-size: 0.98em; }
        .card-artist { font-size: 0.9em; opacity: 0.8; }
        .card-date { font-size: 0.8em; opacity: 0.7; }
        .empty-state {
            text-align: center; padding: 30px 10px; opacity: 0.8;
            font-size: 0.95em;
        }

        /* è©³ç´°è¡¨ç¤º */
        .detail-photo {
            max-width: 100%; max-height: 400px; border-radius: 12px;
            display: block; margin: 0 auto 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            object-fit: cover;
        }
        .detail-block { margin-bottom: 20px; }
        .detail-label {
            font-size: 0.85em; font-weight: 600; opacity: 0.7; margin-bottom: 4px;
            text-transform: uppercase; letter-spacing: 0.06em;
        }
        .detail-text { font-size: 1em; line-height: 1.8; }
        .detail-title-artist { font-size: 1.1em; font-weight: 600; }

        /* X-Y ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆç¸®å°ï¼‰ */
        .axis-canvas-wrapper {
            border:1px solid #e2e8f0;
            border-radius:12px;
            padding:20px;
            background:#f8fafc;
            max-width:380px;
            margin:0 auto;
        }
        .axis-labels-row {
            display:flex;
            justify-content:space-between;
            font-size:0.8em;
            margin-top:8px;
            opacity:0.8;
        }
        .axis-labels-col {
            display:flex;
            flex-direction:column;
            justify-content:space-between;
            font-size:0.8em;
            opacity:0.8;
            height:220px;
        }
        .axis-container {
            display:flex;
            gap:8px;
            align-items:center;
        }
        #axisCanvas {
            display:block;
            background:#ffffff;
            border-radius:8px;
            touch-action:none;
            border:1px solid #cbd5e1;
        }
        .axis-note {
            font-size:0.85em; opacity:0.75; margin-top:8px;
            text-align:center;
        }

        /* ã‚¹ãƒãƒ›èª¿æ•´ */
        @media only screen and (max-width: 600px) {
            body { padding: 10px; }
            .container { border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
            header { padding: 24px 16px; }
            header h1 { font-size: 1.4em; }
            .main-content { padding: 24px 16px; }
            .list-header { flex-direction: column; align-items: stretch; }
            button { width: 100%; }
            .artwork-card { padding: 10px 12px; }
            .card-thumb { width: 50px; height: 50px; }
            .axis-canvas-wrapper { padding: 12px; max-width:100%; }
            .axis-labels-col { height:200px; font-size:0.75em; }
            .axis-labels-row { font-size:0.75em; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="version-badge">v2.4 Grid</div>
        <h1>ğŸ¨ ç¾è¡“é‘‘è³å¯¾è©±ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h1>
        <p>Dissonance & Insight - Personal Edition</p>
    </header>

    <div class="top-nav">
        <button class="btn-secondary" onclick="showSection('sectionList')">
            ãƒˆãƒƒãƒ—ï¼ˆä¸€è¦§ï¼‰ã«æˆ»ã‚‹
        </button>
    </div>

    <div class="main-content">
        <!-- ä½œå“ä¸€è¦§ -->
        <div class="section active" id="sectionList">
            <div class="list-header">
                <h2>ğŸ“š é‘‘è³è¨˜éŒ²ä¸€è¦§</h2>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn-secondary" onclick="exportAllAsMarkdown()">ğŸ’¾ å…¨ä»¶Markdown</button>
                    <button class="btn-primary" onclick="startNewArtwork()">ï¼‹ æ–°ã—ã„ä½œå“ã‚’é‘‘è³</button>
                </div>
            </div>
            <div id="artworkListContainer"></div>
        </div>

        <!-- ä½œå“åŸºæœ¬æƒ…å ± -->
        <div class="section" id="section1">
            <h2 style="margin-bottom: 25px;">ğŸ“‹ ä½œå“ã®åŸºæœ¬æƒ…å ±</h2>

            <div class="form-group">
                <label>ä½œå“ã®å†™çœŸ <span style="opacity: 0.7;">(æ¨å¥¨)</span></label>
                <div class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
                    <div id="uploadPrompt">
                        <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“·</div>
                        <p style="font-weight: 600;">ã‚¯ãƒªãƒƒã‚¯ã—ã¦å†™çœŸã‚’é¸æŠï¼ˆã‚«ãƒ¡ãƒ©ãƒ»ã‚¢ãƒ«ãƒãƒ ï¼‰</p>
                    </div>
                    <img id="photoPreview" class="photo-preview" style="display: none;">
                </div>
                <input type="file"
                       id="photoInput"
                       accept="image/*"
                       style="display: none;"
                       onchange="handlePhotoUpload(event)">
            </div>

            <div class="form-group">
                <label>ä½œå“å *</label>
                <input type="text" id="artworkTitle" placeholder="ä¾‹: ç¡è“®">
            </div>
            <div class="form-group">
                <label>ä½œå®¶å *</label>
                <input type="text" id="artistName" placeholder="ä¾‹: ã‚¯ãƒ­ãƒ¼ãƒ‰ãƒ»ãƒ¢ãƒ">
            </div>

            <div style="display:flex; gap:10px; margin-top:20px; flex-wrap:wrap;">
                <button class="btn-secondary" onclick="showSection('sectionList')">â† ä¸€è¦§ã«æˆ»ã‚‹</button>
                <button class="btn-primary" onclick="goToStep(2)">
                    æ¬¡ã¸ï¼šç¬¬ä¸€å°è±¡ã‚’è¨˜éŒ² â†’
                </button>
            </div>
        </div>

        <!-- ç¬¬ä¸€å°è±¡ï¼šX-Yå›³ -->
        <div class="section" id="section2">
            <h2 style="margin-bottom: 25px;">ğŸ‘ï¸ ç¬¬ä¸€å°è±¡ã®ä½ç½®ã¥ã‘</h2>

            <!-- è»¸é¸æŠ -->
            <div class="form-group">
                <label>ç¬¬1è»¸ï¼ˆXè»¸ï¼‰</label>
                <select id="axis1Select" onchange="drawAxisCanvas()">
                    <option value="time_space">æ™‚é–“çš„è·é›¢ï¼šéå» â†” ç¾åœ¨ â†” æœªæ¥</option>
                    <option value="subject_object">ä¸»è¦³ â†” å®¢è¦³</option>
                    <option value="micro_macro">ãƒŸã‚¯ãƒ­ â†” ãƒã‚¯ãƒ­</option>
                    <option value="personal_collective">å€‹äººçš„ä½“é¨“ â†” é›†å›£çš„ä½“é¨“</option>
                    <option value="still_motion">é™æ­¢ â†” é‹å‹•</option>
                    <option value="moment_duration">ç¬é–“ â†” æŒç¶š</option>
                </select>
            </div>

            <div class="form-group">
                <label>ç¬¬2è»¸ï¼ˆYè»¸ï¼‰</label>
                <select id="axis2Select" onchange="drawAxisCanvas()">
                    <option value="space_phys">ç‰©ç†çš„è·é›¢ï¼šæ¥è¿‘ â†” æ¨™æº– â†” é æ™¯</option>
                    <option value="verbal_nonverbal">è¨€èªåŒ–å¯èƒ½ â†” è¨€èªåŒ–ä¸å¯èƒ½</option>
                    <option value="intent_chance">æ„å›³ â†” å¶ç„¶</option>
                    <option value="inside_outside">ä½œå“å†…éƒ¨ â†” ä½œå“å¤–éƒ¨</option>
                    <option value="passive_active">å—å‹• â†” èƒ½å‹•</option>
                    <option value="memory_expectation">è¨˜æ†¶ â†” äºˆæœŸ</option>
                </select>
            </div>

            <!-- X-Yã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆã‚°ãƒªãƒƒãƒ‰æ–¹å¼ï¼‰ -->
            <div class="form-group">
                <label>X-Yå›³ã«ç¬¬ä¸€å°è±¡ã‚’ãƒ—ãƒ­ãƒƒãƒˆï¼ˆ-5ã€œ+5ï¼‰ *</label>
                <div class="axis-canvas-wrapper">
                    <div class="axis-container">
                        <div class="axis-labels-col">
                            <div id="yTopLabel" style="text-align:center;">+5</div>
                            <div style="text-align:center;">0</div>
                            <div id="yBottomLabel" style="text-align:center;">-5</div>
                        </div>
                        <div>
                            <canvas id="axisCanvas" width="220" height="220"></canvas>
                            <div class="axis-labels-row">
                                <div id="xLeftLabel">-5</div>
                                <div>0</div>
                                <div id="xRightLabel">+5</div>
                            </div>
                        </div>
                    </div>
                    <div class="axis-note">
                        ã‚­ãƒ£ãƒ³ãƒã‚¹å†…ã‚’ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€æœ€ã‚‚è¿‘ã„ã‚°ãƒªãƒƒãƒ‰ç‚¹ï¼ˆ-5ã€œ+5ï¼‰ã«ã‚¹ãƒŠãƒƒãƒ—ã—ã¾ã™ã€‚
                    </div>
                </div>
            </div>

            <!-- ä¸€è¨€ã‚³ãƒ¡ãƒ³ãƒˆ -->
            <div class="form-group">
                <label>ç¬¬ä¸€å°è±¡ã‚³ãƒ¡ãƒ³ãƒˆ *</label>
                <textarea id="firstImpression" rows="3"
                          placeholder="ä¾‹: å·¦ä¸‹ï¼ˆéå»Ã—æ¥è¿‘ï¼‰ã«è¿‘ã„ä½ç½®ã§ã€å¤ã„è¨˜æ†¶ã«è§¦ã‚Œã‚‹ã‚ˆã†ãªæ„Ÿè¦šãŒã‚ã‚‹"></textarea>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px; flex-wrap:wrap;">
                <button class="btn-secondary" onclick="goToStep(1)">â† å‰ã«æˆ»ã‚‹</button>
                <button class="btn-primary" onclick="completeSession()">
                    è¨˜éŒ²ã‚’ä¿å­˜ âœ“
                </button>
            </div>
        </div>

        <!-- ä¿å­˜å®Œäº† -->
        <div class="section" id="section3">
            <h2 style="margin-bottom: 25px;">âœ… ä¿å­˜å®Œäº†</h2>
            <div style="background: #d1ecf1; padding: 30px; border-radius: 12px; text-align: center;">
                <div style="font-size: 4em; margin-bottom: 15px;">ğŸ’¾</div>
                <h3 style="color: var(--primary); margin-bottom: 15px;">ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ</h3>
                <p style="opacity: 0.8; line-height: 1.8;">
                    ã‚ãªãŸã®é‘‘è³è¨˜éŒ²ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
                    ä¸€è¦§ç”»é¢ã‹ã‚‰ã€ã„ã¤ã§ã‚‚è¦‹è¿”ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
                </p>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap:wrap;">
                    <button class="btn-primary" onclick="showSection('sectionList')">
                        ä¸€è¦§ã«æˆ»ã‚‹ ğŸ“š
                    </button>
                    <button class="btn-secondary" onclick="startNewArtwork()">
                        ç¶šã‘ã¦æ–°ã—ã„ä½œå“ã‚’é‘‘è³ â†’
                    </button>
                </div>
            </div>
        </div>

        <!-- ä½œå“è©³ç´° -->
        <div class="section" id="sectionDetail">
            <h2 style="margin-bottom: 25px;">ğŸ–¼ï¸ é‘‘è³è¨˜éŒ²ã®è©³ç´°</h2>
            <div id="detailContent"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap:wrap;">
                <button class="btn-secondary" onclick="showSection('sectionList')">ä¸€è¦§ã«æˆ»ã‚‹</button>
                <button class="btn-secondary" onclick="exportDetailAsMarkdown()">Markdownã§æ›¸ãå‡ºã™</button>
                <button class="btn-primary" onclick="startNewArtwork()">æ–°ã—ã„ä½œå“ã‚’é‘‘è³</button>
            </div>
        </div>
    </div>
</div>

<!-- å¾©å…ƒé€šçŸ¥ -->
<div class="restore-notification" id="restoreNotification">
    <h3 style="margin-bottom: 15px;">ğŸ’¾ å‰å›ã®é€”ä¸­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™</h3>
    <p style="margin-bottom: 20px;">ç¶šãã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ</p>
    <div style="display: flex; gap: 10px;">
        <button class="btn-primary" onclick="restoreData()">å¾©å…ƒã™ã‚‹</button>
        <button class="btn-secondary" onclick="dismissRestore()">æ–°è¦ä½œæˆ</button>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
    // é€²è¡Œä¸­ãƒ‡ãƒ¼ã‚¿
    let artworkData = {
        id: null,
        title: '', artist: '', firstImpression: '',
        photoDataURL: '', timestamp: null,
        axis1Key: 'time_space',
        axis2Key: 'space_phys',
        plotX: 0,  // -5ã€œ+5 ã®æ•´æ•°
        plotY: 0
    };

    let currentStep = 1;
    let currentDetailId = null;

    // ã‚­ãƒ£ãƒ³ãƒã‚¹æç”»é–¢é€£
    let axisCanvas, axisCtx;
    let hasPoint = false;

    const axis1Labels = {
        time_space: { left: 'éå»', center: 'ç¾åœ¨', right: 'æœªæ¥' },
        subject_object: { left: 'ä¸»è¦³', center: 'ä¸­é–“', right: 'å®¢è¦³' },
        micro_macro: { left: 'ãƒŸã‚¯ãƒ­', center: 'ä½œå“å…¨ä½“', right: 'ãƒã‚¯ãƒ­' },
        personal_collective: { left: 'å€‹äººçš„', center: 'ä¸­é–“', right: 'é›†å›£çš„' },
        still_motion: { left: 'é™æ­¢', center: 'ä¸­é–“', right: 'é‹å‹•' },
        moment_duration: { left: 'ç¬é–“', center: 'ä¸­é–“', right: 'æŒç¶š' }
    };

    const axis2Labels = {
        space_phys: { bottom: 'æ¥è¿‘', center: 'æ¨™æº–', top: 'é æ™¯' },
        verbal_nonverbal: { bottom: 'è¨€èªåŒ–å¯èƒ½', center: 'ä¸­é–“', top: 'è¨€èªåŒ–ä¸å¯èƒ½' },
        intent_chance: { bottom: 'æ„å›³', center: 'ä¸­é–“', top: 'å¶ç„¶' },
        inside_outside: { bottom: 'ä½œå“å†…éƒ¨', center: 'ä¸­é–“', top: 'ä½œå“å¤–éƒ¨' },
        passive_active: { bottom: 'å—å‹•', center: 'ä¸­é–“', top: 'èƒ½å‹•' },
        memory_expectation: { bottom: 'è¨˜æ†¶', center: 'ä¸­é–“', top: 'äºˆæœŸ' }
    };

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
    window.addEventListener('DOMContentLoaded', function() {
        checkForSavedData();
        renderArtworkList();
        axisCanvas = document.getElementById('axisCanvas');
        axisCtx = axisCanvas.getContext('2d');
        setupAxisCanvasEvents();
        drawAxisCanvas();
    });

    // localStorage ãƒ˜ãƒ«ãƒ‘
    function getArtworkRecords() {
        const raw = localStorage.getItem('artworkRecords');
        if (!raw) return [];
        try {
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
            console.error('Failed to parse artworkRecords', e);
            return [];
        }
    }

    function saveArtworkRecords(records) {
        localStorage.setItem('artworkRecords', JSON.stringify(records));
    }

    // ä¸€è¦§æç”»
    function renderArtworkList() {
        const container = document.getElementById('artworkListContainer');
        const records = getArtworkRecords();

        if (!records.length) {
            container.innerHTML = `
                <div class="empty-state">
                    ã¾ã é‘‘è³è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                    ã€Œï¼‹ æ–°ã—ã„ä½œå“ã‚’é‘‘è³ã€ã‹ã‚‰ã€æœ€åˆã®1æšã‚’è¨˜éŒ²ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
                </div>
            `;
            return;
        }

        records.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

        const listEl = document.createElement('div');
        listEl.className = 'artwork-list';

        records.forEach(rec => {
            const card = document.createElement('div');
            card.className = 'artwork-card';
            card.onclick = () => openDetail(rec.id);

            let thumb;
            if (rec.photoDataURL) {
                thumb = document.createElement('img');
                thumb.src = rec.photoDataURL;
                thumb.className = 'card-thumb';
            } else {
                thumb = document.createElement('div');
                thumb.className = 'card-thumb';
            }

            const meta = document.createElement('div');
            meta.className = 'card-meta';

            const title = document.createElement('div');
            title.className = 'card-title';
            title.textContent = rec.title || 'ï¼ˆç„¡é¡Œï¼‰';

            const artist = document.createElement('div');
            artist.className = 'card-artist';
            artist.textContent = rec.artist || 'ä½œè€…ä¸æ˜';

            const date = document.createElement('div');
            date.className = 'card-date';
            date.textContent = formatRelativeTime(rec.timestamp);

            meta.appendChild(title);
            meta.appendChild(artist);
            meta.appendChild(date);

            card.appendChild(thumb);
            card.appendChild(meta);

            listEl.appendChild(card);
        });

        container.innerHTML = '';
        container.appendChild(listEl);
    }

    function formatRelativeTime(timestamp) {
        if (!timestamp) return '';
        const now = Date.now();
        const diffMs = now - timestamp;
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHr = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHr / 24);

        if (diffSec < 60) return 'ãŸã£ãŸä»Š';
        if (diffMin < 60) return diffMin + 'åˆ†å‰';
        if (diffHr < 24) return diffHr + 'æ™‚é–“å‰';
        if (diffDay === 1) return 'æ˜¨æ—¥';
        if (diffDay < 7) return diffDay + 'æ—¥å‰';

        const d = new Date(timestamp);
        const y = d.getFullYear();
        const m = d.getMonth() + 1;
        const day = d.getDate();
        return `${y}/${m}/${day}`;
    }

    // æ–°è¦é–‹å§‹
    function startNewArtwork() {
        artworkData = {
            id: null,
            title: '', artist: '', firstImpression: '',
            photoDataURL: '', timestamp: null,
            axis1Key: 'time_space',
            axis2Key: 'space_phys',
            plotX: 0,
            plotY: 0
        };
        localStorage.removeItem('artworkData_v2');

        document.getElementById('artworkTitle').value = '';
        document.getElementById('artistName').value = '';
        document.getElementById('firstImpression').value = '';
        document.getElementById('photoPreview').style.display = 'none';
        document.getElementById('uploadPrompt').style.display = 'block';
        document.getElementById('photoPreview').src = '';
        document.getElementById('axis1Select').value = 'time_space';
        document.getElementById('axis2Select').value = 'space_phys';
        hasPoint = false;
        drawAxisCanvas();

        showSection('section1');
    }

    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // é€”ä¸­ä¿å­˜ç¢ºèª
    function checkForSavedData() {
        const saved = localStorage.getItem('artworkData_v2');
        if (saved) {
            const data = JSON.parse(saved);
            const hoursSince = (new Date().getTime() - data.timestamp) / (1000 * 60 * 60);
            if (hoursSince < 24) {
                document.getElementById('restoreNotification').classList.add('show');
            } else {
                localStorage.removeItem('artworkData_v2');
            }
        }
    }

    function restoreData() {
        const saved = localStorage.getItem('artworkData_v2');
        if (saved) {
            artworkData = JSON.parse(saved);
            document.getElementById('artworkTitle').value = artworkData.title || '';
            document.getElementById('artistName').value = artworkData.artist || '';
            document.getElementById('firstImpression').value = artworkData.firstImpression || '';
            if (artworkData.photoDataURL) {
                document.getElementById('photoPreview').src = artworkData.photoDataURL;
                document.getElementById('photoPreview').style.display = 'block';
                document.getElementById('uploadPrompt').style.display = 'none';
            }
            document.getElementById('axis1Select').value = artworkData.axis1Key || 'time_space';
            document.getElementById('axis2Select').value = artworkData.axis2Key || 'space_phys';
            hasPoint = (artworkData.plotX !== undefined && artworkData.plotY !== undefined);
            showToast('âœ… å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
            showSection('section1');
        }
        dismissRestore();
        drawAxisCanvas();
    }

    function dismissRestore() {
        document.getElementById('restoreNotification').classList.remove('show');
    }

    function autoSave() {
        artworkData.timestamp = new Date().getTime();
        localStorage.setItem('artworkData_v2', JSON.stringify(artworkData));
    }

    // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    function handlePhotoUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                artworkData.photoDataURL = e.target.result;
                document.getElementById('photoPreview').src = e.target.result;
                document.getElementById('photoPreview').style.display = 'block';
                document.getElementById('uploadPrompt').style.display = 'none';
                autoSave();
                showToast('âœ… å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
            };
            reader.readAsDataURL(file);
        }
    }

    // ã‚¹ãƒ†ãƒƒãƒ—ç§»å‹•
    function goToStep(step) {
        if (step === 2) {
            const title = document.getElementById('artworkTitle').value.trim();
            const artist = document.getElementById('artistName').value.trim();
            if (!title || !artist) {
                showToast('âš ï¸ ä½œå“åã¨ä½œå®¶åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                return;
            }
            artworkData.title = title;
            artworkData.artist = artist;
            autoSave();
        }

        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('section' + step).classList.add('active');
        currentStep = step;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // X-Yã‚­ãƒ£ãƒ³ãƒã‚¹è¨­å®šï¼ˆã‚°ãƒªãƒƒãƒ‰æ–¹å¼ï¼š-5ã€œ+5ï¼‰
    function setupAxisCanvasEvents() {
        function handlePoint(evt) {
            evt.preventDefault();
            const rect = axisCanvas.getBoundingClientRect();
            const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
            const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
            const x = clientX - rect.left;
            const y = clientY - rect.top;

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºå†…ã®ç›¸å¯¾åº§æ¨™ï¼ˆ0ã€œ1ï¼‰
            const relX = x / axisCanvas.width;
            const relY = y / axisCanvas.height;

            // -5ã€œ+5ã«ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆ11ç‚¹ã‚°ãƒªãƒƒãƒ‰ï¼‰
            // relX=0 â†’ -5, relX=0.5 â†’ 0, relX=1 â†’ +5
            const gridX = Math.round(relX * 10 - 5);
            const gridY = Math.round((1 - relY) * 10 - 5); // Yè»¸ã¯ä¸ŠãŒæ­£

            artworkData.plotX = Math.max(-5, Math.min(5, gridX));
            artworkData.plotY = Math.max(-5, Math.min(5, gridY));
            hasPoint = true;
            drawAxisCanvas();
        }

        axisCanvas.addEventListener('click', handlePoint);
        axisCanvas.addEventListener('touchstart', handlePoint, { passive: false });
    }

    function drawAxisCanvas() {
        const w = axisCanvas.width;
        const h = axisCanvas.height;
        axisCtx.clearRect(0, 0, w, h);

        const axis1Key = document.getElementById('axis1Select').value;
        const axis2Key = document.getElementById('axis2Select').value;
        artworkData.axis1Key = axis1Key;
        artworkData.axis2Key = axis2Key;

        // ãƒ©ãƒ™ãƒ«æ›´æ–°
        const xLabels = axis1Labels[axis1Key];
        const yLabels = axis2Labels[axis2Key];
        document.getElementById('xLeftLabel').textContent = xLabels.left;
        document.getElementById('xRightLabel').textContent = xLabels.right;
        document.getElementById('yBottomLabel').textContent = yLabels.bottom;
        document.getElementById('yTopLabel').textContent = yLabels.top;

        // èƒŒæ™¯
        axisCtx.fillStyle = '#ffffff';
        axisCtx.fillRect(0, 0, w, h);

        // ã‚°ãƒªãƒƒãƒ‰æç”»ï¼ˆ11x11ï¼‰
        axisCtx.strokeStyle = '#e2e8f0';
        axisCtx.lineWidth = 1;
        for (let i = 0; i <= 10; i++) {
            const pos = (i / 10) * w;
            // ç¸¦ç·š
            axisCtx.beginPath();
            axisCtx.moveTo(pos, 0);
            axisCtx.lineTo(pos, h);
            axisCtx.stroke();
            // æ¨ªç·š
            axisCtx.beginPath();
            axisCtx.moveTo(0, pos);
            axisCtx.lineTo(w, pos);
            axisCtx.stroke();
        }

        // ä¸­å¿ƒç·šå¼·èª¿
        axisCtx.strokeStyle = '#94a3b8';
        axisCtx.lineWidth = 2;
        axisCtx.beginPath();
        axisCtx.moveTo(w / 2, 0);
        axisCtx.lineTo(w / 2, h);
        axisCtx.moveTo(0, h / 2);
        axisCtx.lineTo(w, h / 2);
        axisCtx.stroke();

        // ã‚°ãƒªãƒƒãƒ‰ç‚¹æç”»
        axisCtx.fillStyle = '#cbd5e1';
        for (let i = 0; i <= 10; i++) {
            for (let j = 0; j <= 10; j++) {
                const px = (i / 10) * w;
                const py = (j / 10) * h;
                axisCtx.beginPath();
                axisCtx.arc(px, py, 2, 0, Math.PI * 2);
                axisCtx.fill();
            }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒƒãƒˆ
        if (hasPoint) {
            // plotX, plotY: -5ã€œ+5 â†’ ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™
            const relX = (artworkData.plotX + 5) / 10;
            const relY = 1 - (artworkData.plotY + 5) / 10; // Yè»¸åè»¢
            const px = relX * w;
            const py = relY * h;

            axisCtx.fillStyle = '#e11d48';
            axisCtx.beginPath();
            axisCtx.arc(px, py, 7, 0, Math.PI * 2);
            axisCtx.fill();

            // ç™½æ 
            axisCtx.strokeStyle = '#ffffff';
            axisCtx.lineWidth = 2;
            axisCtx.beginPath();
            axisCtx.arc(px, py, 7, 0, Math.PI * 2);
            axisCtx.stroke();
        }
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº† â†’ ä¿å­˜
    function completeSession() {
        const impression = document.getElementById('firstImpression').value.trim();
        if (!impression) {
            showToast('âš ï¸ ç¬¬ä¸€å°è±¡ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
            return;
        }
        if (!hasPoint) {
            showToast('âš ï¸ X-Yå›³ã«ãƒã‚¤ãƒ³ãƒˆã‚’æ‰“ã£ã¦ãã ã•ã„', 'warning');
            return;
        }
        artworkData.firstImpression = impression;
        artworkData.timestamp = new Date().getTime();

        if (!artworkData.id) {
            artworkData.id = crypto.randomUUID ? crypto.randomUUID() : String(artworkData.timestamp);
        }

        const records = getArtworkRecords();
        records.push(artworkData);
        saveArtworkRecords(records);

        localStorage.removeItem('artworkData_v2');
        renderArtworkList();
        showSection('section3');
        showToast('âœ… é‘‘è³è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
    }

    // è©³ç´°è¡¨ç¤º
    function openDetail(id) {
        const records = getArtworkRecords();
        const rec = records.find(r => r.id === id);
        if (!rec) {
            showToast('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'warning');
            return;
        }
        currentDetailId = id;

        const container = document.getElementById('detailContent');
        container.innerHTML = '';

        if (rec.photoDataURL) {
            const img = document.createElement('img');
            img.src = rec.photoDataURL;
            img.className = 'detail-photo';
            container.appendChild(img);
        }

        const infoBlock = document.createElement('div');
        infoBlock.className = 'detail-block';
        infoBlock.innerHTML = `
            <div class="detail-title-artist">
                ${rec.title || 'ï¼ˆç„¡é¡Œï¼‰'}<br>
                <span style="font-size:0.9em; opacity:0.8;">${rec.artist || 'ä½œè€…ä¸æ˜'}</span>
            </div>
        `;
        container.appendChild(infoBlock);

        const dateBlock = document.createElement('div');
        dateBlock.className = 'detail-block';
        const dt = new Date(rec.timestamp || Date.now());
        const dtText = `${dt.getFullYear()}å¹´${dt.getMonth()+1}æœˆ${dt.getDate()}æ—¥ `
            + `${dt.getHours().toString().padStart(2,'0')}:${dt.getMinutes().toString().padStart(2,'0')}`;
        dateBlock.innerHTML = `
            <div class="detail-label">é‘‘è³æ—¥æ™‚</div>
            <div class="detail-text">${dtText}</div>
        `;
        container.appendChild(dateBlock);

        const axisBlock = document.createElement('div');
        axisBlock.className = 'detail-block';
        axisBlock.innerHTML = `
            <div class="detail-label">é¸æŠã—ãŸè»¸</div>
            <div class="detail-text">
                ç¬¬1è»¸ï¼ˆXè»¸ï¼‰ï¼š${axisKeyToLabel(rec.axis1Key)}<br>
                ç¬¬2è»¸ï¼ˆYè»¸ï¼‰ï¼š${axisKeyToLabel(rec.axis2Key)}
            </div>
        `;
        container.appendChild(axisBlock);

        const plotBlock = document.createElement('div');
        plotBlock.className = 'detail-block';
        plotBlock.innerHTML = `
            <div class="detail-label">ãƒ—ãƒ­ãƒƒãƒˆåº§æ¨™ï¼ˆ-5ã€œ+5ï¼‰</div>
            <div class="detail-text">
                Xè»¸: ${rec.plotX ?? 0} ï¼ˆ${axisKeyToLabel(rec.axis1Key)}ï¼‰<br>
                Yè»¸: ${rec.plotY ?? 0} ï¼ˆ${axisKeyToLabel(rec.axis2Key)}ï¼‰
            </div>
        `;
        container.appendChild(plotBlock);

        const impressionBlock = document.createElement('div');
        impressionBlock.className = 'detail-block';
        impressionBlock.innerHTML = `
            <div class="detail-label">ç¬¬ä¸€å°è±¡ã‚³ãƒ¡ãƒ³ãƒˆ</div>
            <div class="detail-text">${(rec.firstImpression || '').replace(/\n/g,'<br>') || 'ï¼ˆæœªå…¥åŠ›ï¼‰'}</div>
        `;
        container.appendChild(impressionBlock);

        showSection('sectionDetail');
    }

    function axisKeyToLabel(key) {
        switch(key) {
            case 'time_space': return 'æ™‚é–“çš„è·é›¢';
            case 'subject_object': return 'ä¸»è¦³ â†” å®¢è¦³';
            case 'micro_macro': return 'ãƒŸã‚¯ãƒ­ â†” ãƒã‚¯ãƒ­';
            case 'personal_collective': return 'å€‹äººçš„ä½“é¨“ â†” é›†å›£çš„ä½“é¨“';
            case 'still_motion': return 'é™æ­¢ â†” é‹å‹•';
            case 'moment_duration': return 'ç¬é–“ â†” æŒç¶š';
            case 'space_phys': return 'ç‰©ç†çš„è·é›¢';
            case 'verbal_nonverbal': return 'è¨€èªåŒ–å¯èƒ½ â†” è¨€èªåŒ–ä¸å¯èƒ½';
            case 'intent_chance': return 'æ„å›³ â†” å¶ç„¶';
            case 'inside_outside': return 'ä½œå“å†…éƒ¨ â†” ä½œå“å¤–éƒ¨';
            case 'passive_active': return 'å—å‹• â†” èƒ½å‹•';
            case 'memory_expectation': return 'è¨˜æ†¶ â†” äºˆæœŸ';
            default: return key;
        }
    }

    // Markdownæ›¸ãå‡ºã—
    function formatDateForMD(timestamp) {
        const d = new Date(timestamp || Date.now());
        const y = d.getFullYear();
        const m = (d.getMonth()+1).toString().padStart(2,'0');
        const day = d.getDate().toString().padStart(2,'0');
        const hh = d.getHours().toString().padStart(2,'0');
        const mm = d.getMinutes().toString().padStart(2,'0');
        return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    function markdownForArtwork(rec) {
        const title = rec.title || 'ï¼ˆç„¡é¡Œï¼‰';
        const artist = rec.artist || 'ä½œè€…ä¸æ˜';
        const dt = formatDateForMD(rec.timestamp);
        const axis1 = axisKeyToLabel(rec.axis1Key);
        const axis2 = axisKeyToLabel(rec.axis2Key);
        const impression = rec.firstImpression || '';
        const plotX = rec.plotX ?? 0;
        const plotY = rec.plotY ?? 0;

        return [
            `# ${title} â€“ ${artist}`,
            '',
            `- é‘‘è³æ—¥æ™‚: ${dt}`,
            `- ç¬¬1è»¸ï¼ˆXè»¸ï¼‰: ${axis1}`,
            `- ç¬¬2è»¸ï¼ˆYè»¸ï¼‰: ${axis2}`,
            '',
            '## ç¬¬ä¸€å°è±¡ã‚³ãƒ¡ãƒ³ãƒˆ',
            impression,
            '',
            '## X-Yãƒ—ãƒ­ãƒƒãƒˆåº§æ¨™ï¼ˆ-5ã€œ+5ï¼‰',
            `- Xè»¸: ${plotX} ï¼ˆ${axis1}ï¼‰`,
            `- Yè»¸: ${plotY} ï¼ˆ${axis2}ï¼‰`,
            ''
        ].join('\n');
    }

    function downloadTextFile(content, filename, mime = 'text/markdown') {
        const blob = new Blob([content], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function exportDetailAsMarkdown() {
        if (!currentDetailId) {
            showToast('âš ï¸ æ›¸ãå‡ºã™ä½œå“ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
            return;
        }
        const records = getArtworkRecords();
        const rec = records.find(r => r.id === currentDetailId);
        if (!rec) {
            showToast('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'warning');
            return;
        }
        const md = markdownForArtwork(rec);
        const safeTitle = (rec.title || 'untitled').replace(/[\\\/:*?"<>|]/g, '_');
        const dt = formatDateForMD(rec.timestamp).replace(/[: ]/g, '-');
        const filename = `${dt}-${safeTitle}.md`;
        downloadTextFile(md, filename);
        showToast('âœ… Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ');
    }

    function exportAllAsMarkdown() {
        const records = getArtworkRecords();
        if (!records.length) {
            showToast('âš ï¸ æ›¸ãå‡ºã™é‘‘è³è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
            return;
        }
        const parts = [];
        records.sort((a,b) => (a.timestamp||0)-(b.timestamp||0));
        records.forEach((rec, idx) => {
            parts.push(markdownForArtwork(rec));
            if (idx !== records.length - 1) parts.push('---');
        });
        const all = parts.join('\n');
        const now = formatDateForMD(Date.now()).replace(/[: ]/g,'-');
        const filename = `artwork-records-${now}.md`;
        downloadTextFile(all, filename);
        showToast('âœ… å…¨ä»¶ã‚’Markdownã§æ›¸ãå‡ºã—ã¾ã—ãŸ');
    }

    // Toast
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.background = type === 'warning' ? '#e74c3c' : '#27ae60';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
</script>
</body>
</html>
